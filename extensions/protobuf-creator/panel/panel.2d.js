"use strict";function join(t){return Editor.url(`packages://protobuf-creator/${t}`)}module.paths.push(join("node_modules"));const{pbjs:pbjs,pbts:pbts}=require("protobufjs/cli"),path=require("path"),fs=require("fs"),chokidar=require("chokidar"),pkg=require(join("package.json")),cachePath=join(".cache.2d.json");fs.existsSync(cachePath)||fs.writeFileSync(cachePath,JSON.stringify({optionCreate:!0,optionLimit:!0,optionVerify:!0,watchUpdate:!1,filter:"\\.proto$",fileName:"",input:null,output:null},null,4));let vm,running,watcher,cache=require(cachePath);function openDir(t){return Editor.Dialog.openFile({defaultPath:t,properties:["openDirectory"]})}function readProto(t,e,r){const o=fs.readdirSync(e);for(let i=0;i<o.length;i++){const n=path.join(e,o[i]);fs.statSync(path.join(e,o[i])).isDirectory()?readProto(t,n,r):t.test(n)&&r.push(n)}}function dbPath(t){return/^db/.test(t)?t:"db:/"+t.slice(Editor.Project.path.length).replace(/\\/g,"/")}function compileProto(t,e){return new Promise((r,o)=>{pbjs.main(["--force-number","-t","static","-r","creator","-w","commonjs"].concat(t),(t,i)=>{if(t)return o(t);writeFileToProject(e,i.replace(/\$protobuf/g,"protobuf").replace("protobuf.roots.creator = {}","protobuf.roots.creator = $util.global"),r)})})}function generateTsd(t){const e=t.replace(".js",".d.ts");return new Promise((r,o)=>{process.execPath="node",pbts.main(["-m",t],(t,i)=>{if(t)return o(t);writeFileToProject(e,`declare global {\n ${i} \n}\nexport {}`,r)})})}function copyProtojs(t){return new Promise((e,r)=>{const o=fs.readFileSync(join("node_modules/protobufjs/dist/minimal/protobuf.min.js"));writeFileToProject(`${t}${path.sep}protobuf.min.js`,o,r=>{const o=fs.readFileSync(join("node_modules/protobufjs/index.d.ts"));writeFileToProject(`${t}${path.sep}protobuf.d.ts`,o,t=>e(r))})})}function writeFileToProject(t,e,r){Editor.assetdb.createOrSave(dbPath(t),e,(t,e)=>{if(t)throw t;r(Array.isArray(e)?e[0]:e)})}exports.style=fs.readFileSync(join("panel/panel.2d.css")),exports.template=fs.readFileSync(join("panel/panel.2d.html")),exports.$={root:"#root"},exports.close=function(){if(!vm)return;let t=!1;for(const e in cache)Object.hasOwnProperty.call(vm,e)&&(cache[e]=vm[e],t=!0);t&&fs.writeFileSync(cachePath,JSON.stringify(cache,null,4))},exports.ready=function(){vm=new Vue({el:this.shadowRoot,data:{input:cache.input,output:cache.output,fileName:cache.fileName||Editor.Project.name,optionCreate:cache.optionCreate,optionLimit:cache.optionLimit,optionVerify:cache.optionVerify,watchUpdate:cache.watchUpdate,filter:cache.filter||"\\.proto$"},methods:{t:t=>Editor.T(`${pkg.name}.${t}`),selectDirImport(){if(running)return Editor.warn(this.t("executeWarn"));const t=openDir(path.join(Editor.Project.path,"assets"));if(-1===t)return Editor.warn(this.t("form.warnInput"));this.output=t[0],running=!0,copyProtojs(this.output).then(()=>Editor.log(this.t("executeSuccess"))).catch(t=>Editor.error(t)).finally(()=>running=!1)},selectInputDir(){const t=openDir(Editor.Project.path);-1!==t&&(this.input=t[0])},checkbox(t){Object.hasOwnProperty.call(this,t)&&(this[t]=!this[t])},execute(){if(running)return Editor.warn(this.t("executeWarn"));if(""===this.output)return Editor.warn(this.t("form.warnOutput"));if(""===this.input||""===this.fileName||""===this.filter)return Editor.warn(this.t("form.warnInput"));let t=["--no-beautify"];this.optionCreate&&(t.push("--no-create"),t.push("--no-convert")),this.optionVerify&&t.push("--no-verify"),this.optionLimit&&t.push("--no-delimited");const e=new RegExp(this.filter);readProto(e,this.input,t);const r=path.join(this.output,`protobuf+${this.fileName}.js`);this.watchUpdate&&!watcher&&((watcher=chokidar.watch(this.input,{ignored:/\.proto{0}$/})).on("unlink",o=>{e.test(o)&&(Editor.log(this.t("deleteFile"),o),t.splice(t.indexOf(o),1),this._createFiles(t,r))}),watcher.on("change",o=>{e.test(o)&&(Editor.log(this.t("changeFile"),o),-1===t.indexOf(o)&&t.push(o),this._createFiles(t,r))})),this._createFiles(t,r)},_createFiles(t,e){if(running=!0,e=e.replace(/\+/g,""),!/\.proto$/.test(t[t.length-1]))return Editor.assetdb.delete([dbPath(e),dbPath(e.replace(".js",".d.ts"))]),running=!1,Editor.warn(this.t("form.warnFilter"));compileProto(t,e).then(generateTsd(e)).then(()=>Editor.log(this.t("executeSuccess"))).catch(t=>Editor.error(t)).finally(()=>running=!1)}}})};