"use strict";const path=require("path"),fs=require("fs"),chokidar=require("chokidar"),UglifyJS=require("uglify-js"),dialog=require("electron").remote["dialog"];function join(t){return path.join(__dirname,"../",t)}module.paths.push(join("node_modules"));const{pbjs,pbts}=require("protobufjs/cli"),pkg=require(join("package.json")),Vue=require(join("libs/vue.min.js")),cachePath=join(".cache.3d.json");fs.existsSync(cachePath)||fs.writeFileSync(cachePath,JSON.stringify({optionLong:!1,optionCreate:!0,optionLimit:!0,optionVerify:!0,watchUpdate:!1,filter:"\\.proto$",fileName:"",input:null,output:null},null,4)),require("fix-path")();let vm,panel,running,watcher,cache=require(cachePath);async function openDir(t){t=await Editor.Dialog.showOpenDialog({defaultPath:t,properties:["openDirectory"]});return Array.isArray(t)?t[0]:t.filePaths?t.filePaths[0]:null}function readProto(e,o,r){var i=fs.readdirSync(o);for(let t=0;t<i.length;t++){var n=path.join(o,i[t]);fs.statSync(path.join(o,i[t])).isDirectory()?readProto(e,n,r):e.test(n)&&r.push(n)}}function dbPath(t){return/^db/.test(t)?t:"db:/"+t.slice(Editor.Project.path.length).replace(/\\/g,"/")}function compileProto(n,a){return Editor.log("开始编译协议"),new Promise((r,i)=>{pbjs.main(["-t","static","-r","creator","-w","commonjs"].concat(n),(t,e)=>{if(t)return i(t);let o=e.replace(/\$protobuf/g,"protobuf").replace("protobuf.roots.creator = {}","protobuf.roots.creator = $util.global");-1!==n.indexOf("--force-long")&&((t=o.split(/\r\n|\n|\r/gm)).splice(2,0,...["try {","var Long = require('./long');","protobuf.util.Long = Long;","protobuf.configure();","protobuf.util.global.Long = Long;","} catch (_) {}"]),o=t.join("\r\n")),writeFileToProject(a,o,r)})})}function generateTsd(t){Editor.log("开始生成tsd");const i=t.replace(".js",".d.ts");return new Promise((o,r)=>{process.execPath="node",pbts.main(["-m",t],(t,e)=>{t?r(t):writeFileToProject(i,`declare global {
 ${e} 
}
export {}`,o)})})}function copyProtoJs(r){return Editor.log("开始拷贝Proto库"),new Promise((o,t)=>{var e=fs.readFileSync(join("node_modules/protobufjs/dist/minimal/protobuf.min.js"));writeFileToProject(r+"/protobuf.min.js",e,e=>{var t=fs.readFileSync(join("node_modules/protobufjs/index.d.ts"));writeFileToProject(r+"/protobuf.d.ts",t,t=>o(e))})})}function copyLongJs(r){return Editor.log("开始拷贝Long库"),new Promise((o,t)=>{var e=fs.readFileSync(join("node_modules/long/dist/long.js"));writeFileToProject(r+"/long.js",e,e=>{let t=fs.readFileSync(join("node_modules/@types/long/index.d.ts")).toString();for(;-1!==t.indexOf("export");)t=t.substring(t.indexOf(";")+1);t=t.replace(/declare/g,"export"),writeFileToProject(r+"/long.d.ts",`declare global {
 ${t} 
}
export {}`,t=>o(e))})})}function compressJs(r){return new Promise((t,e)=>{var o=fs.readFileSync(r,"utf8"),o=UglifyJS.minify(o);o.error?e(o.error):(fs.writeFileSync(r,o.code),t())})}async function writeFileToProject(t,e,o){var r=dbPath(t);let i;fs.existsSync(t)?(i=await Editor.Message.request("asset-db","query-uuid",r),await Editor.Message.request("asset-db","save-asset",i,e)):i=await Editor.Message.request("asset-db","create-asset",r,e),o(i)}Editor.T=Editor.I18n.t,Editor.warn=console.warn,Editor.log=console.log,Editor.error=console.error,Editor.Dialog.showOpenDialog=dialog.showOpenDialog,exports.style=fs.readFileSync(join("panel/panel.3d.css"),"utf8"),exports.template=fs.readFileSync(join("panel/panel.3d.html"),"utf8"),exports.$={root:"#root"},exports.close=function(){if(vm){let t=!1;for(const e in cache)Object.hasOwnProperty.call(vm.$data,e)&&(cache[e]=vm.$data[e],t=!0);t&&fs.writeFileSync(cachePath,JSON.stringify(cache,null,4))}},exports.ready=function(){panel=this,vm=new Vue({el:panel.$.root,data:{input:cache.input||"",output:cache.output||path.join(Editor.Project.path,"assets"),fileName:cache.fileName||path.basename(Editor.Project.path),optionLong:cache.optionLong,optionCreate:cache.optionCreate,optionLimit:cache.optionLimit,optionVerify:cache.optionVerify,watchUpdate:cache.watchUpdate,filter:cache.filter||"\\.proto$"},created:function(){this.$nextTick(()=>{for(const t in vm.$data)Object.hasOwnProperty.call(vm.$refs,t)&&(vm.$refs[t].value=vm.$data[t])})},methods:{t(t){return Editor.T(pkg.name+"."+t)},async selectDirImport(){var t;return running?Editor.warn(this.t("executeWarn")):(t=await openDir(path.join(Editor.Project.path,"assets")))?(this.output=t,running=!0,void copyProtoJs(this.output).then(()=>Editor.log(this.t("executeSuccess"))).catch(t=>Editor.error(t)).finally(()=>running=!1)):Editor.warn(this.t("form.warnDirectory"))},async selectInputDir(){var t=await openDir(Editor.Project.path);if(!t)return Editor.warn(this.t("form.warnDirectory"));this.input=t},onChange(t){Object.hasOwnProperty.call(this,t)&&(this[t]=this.$refs[t].value)},onCheckbox(t){Object.hasOwnProperty.call(this,t)&&(this[t]=!this[t])},execute(){if(running)return Editor.warn(this.t("executeWarn"));if(""===this.output)return Editor.warn(this.t("form.warnOutput"));if(""===this.input||""===this.fileName||""===this.filter)return Editor.warn(this.t("form.warnInput"));let e=["--no-beautify"];this.optionCreate&&(e.push("--no-create"),e.push("--no-convert")),this.optionVerify&&e.push("--no-verify"),this.optionLimit&&e.push("--no-delimited"),e.push(this.optionLong?"--force-long":"--force-number");const o=new RegExp(this.filter),r=(readProto(o,this.input,e),path.join(this.output,`protobuf+${this.fileName}.js`));this.watchUpdate&&!watcher&&((watcher=chokidar.watch(this.input,{ignored:/\.proto{0}$/})).on("unlink",t=>{o.test(t)&&(Editor.log(this.t("deleteFile"),t),e.splice(e.indexOf(t),1),this._createFiles(e,r))}),watcher.on("change",t=>{o.test(t)&&(Editor.log(this.t("changeFile"),t),-1===e.indexOf(t)&&e.push(t),this._createFiles(e,r))})),this._createFiles(e,r)},async _createFiles(e,o){if(running=!0,o=o.replace(/\+/g,""),!/\.proto$/.test(e[e.length-1]))return[o,o.replace(".js",".d.ts")].forEach(t=>{fs.existsSync(t)&&fs.unlinkSync(t)}),running=!1,Editor.warn(this.t("form.warnFilter"));do{var r=path.dirname(o);let t=null;if(this.optionLong&&!fs.existsSync(r+"/long.js")&&!(t=await copyLongJs(r).catch(t=>Editor.error(t.message))))break;if(!(t=await compileProto(e,o).catch(t=>Editor.error(t.message))))break;if(!(t=await generateTsd(o).catch(t=>Editor.error(t.message))))break;await compressJs(o).catch(t=>Editor.error(t.message))}while(0);running=!1,Editor.log(this.t("executeSuccess"))}}})};